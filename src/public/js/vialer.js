!function(t){var e={};function i(a){if(e[a])return e[a].exports;var n=e[a]={i:a,l:!1,exports:{}};return t[a].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,a){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:a})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var a=Object.create(null);if(i.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(a,n,function(e){return t[e]}.bind(null,n));return a},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="/",i(i.s=0)}([function(t,e,i){i(1),t.exports=i(2)},function(t,e){$.widget("ajtarragona.vialerMap",{options:{center:{lat:0,lng:0},zoom:15,geolocate:!0,multiple:!1,readonly:!1,disabled:!1,animation:!1,cluster:!0,fitbounds:!1,clusterMinZoom:15,mapType:"roadmap",method:"get",url:!1,customicons:!1,controls:{zoom:!0,mapType:!1,scale:!1,streetView:!1,rotate:!1,fullscreen:!0},styles:[{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"transit",stylers:[{visibility:"off"}]}]},_create:function(){var t=this;this.options=$.extend({},this.options,this.element.data()),this.mapoptions={center:this.options.center,zoom:this.options.zoom,mapTypeId:this.options.mapType,zoomControl:this.options.controls.zoom,mapTypeControl:this.options.controls.mapType,mapTypeControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM,mapTypeIds:["roadmap","satellite","hybrid","terrain"]},scaleControl:this.options.controls.scale,streetViewControl:this.options.controls.streetView,rotateControl:this.options.controls.rotate,fullscreenControl:this.options.controls.fullscreen,styles:this.options.styles},this.gmap=new google.maps.Map(this.element[0],this.mapoptions),this.infoWindow=new google.maps.InfoWindow({map:this.gmap}),this.options.geolocate?this._geolocate((function(){t._initAll()})):t._initAll()},_initAll:function(){},_geolocate:function(t){var e=this;navigator.geolocation?navigator.geolocation.getCurrentPosition((function(i){e.geoposition=i;var a={lat:i.coords.latitude,lng:i.coords.longitude};e.setCenter(a),executeCallback(t)}),(function(){e._handleLocationError(!0)})):e._handleLocationError(!1)},_handleLocationError:function(t){var e=this;e.infoWindow.setContent(t?"Error: The Geolocation service failed.":"Error: Your browser doesn't support geolocation."),e.infoWindow.setPosition(e.gmap.getCenter()),e.infoWindow.open(e.map)},_isReadonly:function(){return this.options.readonly||this.options.disabled},enable:function(){this.options.readonly=!0},disable:function(){this.options.readonly=!1},setCenter:function(t){this.options.center=t,this.gmap&&this.gmap.setCenter(t)},getCenter:function(){return this.gmap.getCenter()},deleteMarker:function(){this.marker&&(this.marker.setMap(null),this.marker=null,this.element.trigger("vialermap:markerdeleted",this))},setMarkerPosition:function(t,e){var i=this;if((is_int(parseInt(t))||is_float(parseFloat(t)))&&(is_int(parseInt(e))||is_float(parseFloat(e)))){var a={lat:parseFloat(t),lng:parseFloat(e)};this.marker?(this.marker.setPosition(a),this.gmap.getBounds().contains(this.marker.getPosition())||this.setCenter(a)):(this.addMarker(a),setTimeout((function(){i.setCenter(a)}),10))}},getMarkerPosition:function(){return this.marker?this.marker.getPosition():null},addMarker:function(t){var e=this;if(t||(t=this.getCenter()),this.marker)this.setMarkerPosition(t.lat(),t.lng());else{var i={position:t,draggable:!this._isReadonly(),animation:!!this.options.animation&&google.maps.Animation.DROP,map:this.gmap};this.marker=new google.maps.Marker(i),this.marker.addListener("drag",(function(){})),this.marker.addListener("dragend",(function(){e.element.trigger("vialermap:markerchanged",e)})),this.marker.addListener("rightclick",(function(t){e._isReadonly()||e.deleteMarker()}))}},hasMarker:function(){return null!=this.marker}}),$.widget("ajtarragona.vialerField",{options:{},_create:function(){var t=this;this.options=$.extend({},this.options,this.element.data()),this.name=this.element.find("input.vialer-value"),this.inputs=this.element.find("input"),this.searchButtons=this.element.find(".search-button"),this.clearButton=this.element.find(".clear-button"),this.parcelaButton=this.element.find(".refcat-button"),this.markerButton=this.element.find(".marker-button"),this.map=this.element.find(".vialer-map"),this.inputVia=this.element.find("input.tt-input"),this.searchButtons.on("click",(function(e){var i=$(this).attr("value");t._search(i)})),this.clearButton.on("click",(function(){t.inputs.val(""),t.inputVia.tgnAutocomplete("clear"),t.map.vialerMap("deleteMarker")})),this.inputs.on("keyup",(function(){t._isReadonly()||t._update()})),this.inputVia.on("tgnautocomplete:change",(function(e,i){t._setFieldValue("via.tipus",i.item.tipusVia),t._setFieldValue("via.nom",i.item.nomLlarg),t._update()})),this.parcelaButton.on("click",(function(){t._openParcela()})),this.markerButton.on("click",(function(e){t.map.vialerMap("addMarker");var i=t.map.vialerMap("getMarkerPosition");t._setFieldValue("location.lat",i.lat()),t._setFieldValue("location.lng",i.lng()),t._update()})),this.map.vialerMap(),this.map.on("vialermap:markerchanged",(function(e,i){var a=i.getMarkerPosition();t._setFieldValue("location.lat",a.lat()),t._setFieldValue("location.lng",a.lng()),t._update()})),this.map.on("vialermap:markerdeleted",(function(e,i){t._setFieldValue("location.lat",""),t._setFieldValue("location.lng",""),t._update()})),this._updateValue()},_initMap:function(){},_openParcela:function(){var t=this._value(),e=route("vialer.parcela",{refcat:t.refcat});TgnModal.open(e,"get",{},{onsuccess:function(t){},size:"lg",padding:0})},_initModalForm:function(t){var e=this;t.find(".vialer-search-form").on("submit",(function(i){i.preventDefault();var a=$(this),n=a.attr("action"),o=a.attr("method");$("html").stopLoading();var r=a.serializeControls();t.find("#vialer-search-results").startLoading(),$.ajax({url:n,type:o,data:r,dataType:"html",success:function(i){t.find("#vialer-search-results").html($(i).find("#vialer-search-results")).tgnInitAll(),e._initSearchResults(t),t.find("#vialer-search-results").stopLoading()},error:function(e){t.find("#vialer-search-results").stopLoading(),TgnFlash.error(__("Error recuperando domicilios"))}})}))},_search:function(t){var e=this,i=route("vialer.search",{type:t}),a=e._value();TgnModal.open(i,"post",a,{onsuccess:function(t){e._initModalForm(t),e._initSearchResults(t)},size:"lg",padding:0})},_initSearchResults:function(t){var e=this,i=t.find("table").data("numerero");t.find("table tbody tr").on("click",(function(a){i?e._selectNumerero($(this),t):e._recuperaDomicili($(this),t)}))},_selectNumerero:function(t,e){var i=this,a=t.data("rc"),n=t.data("numero"),o=route("vialer.numerero",{rc:a});t.startLoading(),$.ajax({url:o,type:"get",data:{},dataType:"html",success:function(a){e.find(".vialer-search-form input[name=numero]").val(n),e.find(".vialer-search-form input[name=escala]").val(""),e.find(".vialer-search-form input[name=bloc]").val(""),e.find(".vialer-search-form input[name=planta]").val(""),e.find(".vialer-search-form input[name=porta]").val(""),e.find("#vialer-search-results").html(a).tgnInitAll(),i._initSearchResults(e),t.stopLoading()},error:function(e){t.stopLoading(),TgnFlash.error(__("Error recuperando domicilios"))}})},_recuperaDomicili:function(t,e){var i=this,a=t.data("rc"),n=route("vialer.domicili",{rc:a});t.startLoading(),$.ajax({url:n,type:"get",data:{},dataType:"json",success:function(a){e.modal("hide"),t.stopLoading(),a.viaIris?(i.inputVia.tgnAutocomplete("value",{value:a.viaIris.code,name:a.viaIris.acronym+" "+a.viaIris.stname}),i._setFieldValue("via.tipus",a.viaIris.acronym),i._setFieldValue("via.nom",a.viaIris.stname),i._setFieldValue("via.codi",a.viaIris.code)):(i.inputVia.tgnAutocomplete("value",{value:a.via.codigoVia,name:a.via.tipoVia+" "+a.via.nombreVia}),i._setFieldValue("via.tipus",a.via.tipoVia),i._setFieldValue("via.nom",a.via.nombreVia),i._setFieldValue("via.codi",a.via.codigoVia)),i._setFieldValue("numero",a.numero),i._setFieldValue("lletra",a.letra),i._setFieldValue("escala",a.escalera),i._setFieldValue("bloc",a.bloque),i._setFieldValue("planta",a.planta),i._setFieldValue("porta",a.puerta),i._setFieldValue("codi_postal",a.codigo_postal),i._setFieldValue("refcat",a.rc.completa),i._setFieldValue("location.lat",a.xy.lat),i._setFieldValue("location.lng",a.xy.lng),i._setFieldValue("provincia",a.provincia),i._setFieldValue("municipi",a.municipi),i._setFieldValue("districte",a.districte),i._setFieldValue("seccio",a.seccio),i._setFieldValue("districte_administratiu",a.districte_administratiu?a.districte_administratiu.toUpperCase():""),i._update(),i._setMapMarker(a.xy.lat,a.xy.lng)},error:function(e){t.stopLoading(),TgnFlash.error(__("Error recuperando domicilio"))}})},_setMapMarker:function(t,e){},_setFieldValue:function(t,e){t="["+t.replace(".","][")+"]";var i=this.element.find('input[name="'+this.options.name+t+'"]');i.length>0&&i.val(e)},_getFieldValue:function(t){},_toJson:function(){return JSON.stringify(this._value(),void 0,4)},_data_get:function(t,e){var i=e.split("."),a=t[i[0]];if(i[1]){i.splice(0,1);var n=i.join(".");return this._data_get(a,n)}return a},_value:function(){var t=this.element.closest("form").serializeControls(),e=this.options.name.replaceAll("[",".").replaceAll("]","");return this._data_get(t,e)},_isReadonly:function(){return this.options.readonly||this.options.disabled},_updateValue:function(){var t=this,e=t._toJson();t.element.find("#"+t.options.name+"-value").html(e),t._updateMapMarker(),t._updateParcela()},_update:function(){var t=this;t._updateValue(),t.element.trigger("changed",t)},_updateParcela:function(){var t=this,e=t._value();e.refcat&&e.refcat.length>=14?t.parcelaButton.prop("disabled",!1).removeClass("disabled"):t.parcelaButton.prop("disabled",!0).addClass("disabled")},_updateMapMarker:function(){var t=this,e=t._value();t.map.vialerMap("setMarkerPosition",e.location.lat,e.location.lng),t.map.vialerMap("hasMarker")?t.markerButton.prop("disabled",!0).addClass("disabled"):t._isReadonly()||t.markerButton.prop("disabled",!1).removeClass("disabled")}})},function(t,e){}]);